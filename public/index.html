<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BloodDrive ‚Äî Control Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --tile: rgba(255,255,255,.75);
      --bg1: #0f172a; /* slate-900 */
      --bg2: #111827; /* gray-900 */
      --accent: #22c55e; /* emerald-500 */
      --accent2: #38bdf8; /* sky-400 */
      --pre: #10b981;     /* pre-reg green */
      --walk: #6366f1;    /* walk-in indigo */
    }
    .pill{ padding:.15rem .5rem; border-radius:.5rem; font-size:.75rem; background:#eef2ff; color:#3730a3 }
    .card{ background:#fff; border-radius:.75rem; box-shadow:0 4px 12px rgba(0,0,0,.05); padding:12px }
    .btn{ padding:.5rem .75rem; border-radius:.5rem; background:#e5e7eb }
    .btn-primary{ background:#2563eb; color:#fff }
    .btn-warn{ background:#dc2626; color:#fff }
    .btn-ok{ background:#059669; color:#fff }
    .btn-sky{ background:#0ea5e9; color:#fff }
    .btn-emerald{ background:#10b981; color:#fff }
    .btn-purple{ background:#7c3aed; color:#fff }
    .muted{ color:#6b7280 }

    /* Beautiful fullscreen waiting */
    .slide-wrap{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(34,197,94,.25), transparent 60%),
                  radial-gradient(1200px 600px at 80% -20%, rgba(56,189,248,.25), transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 1px rgba(255,255,255,.05), 0 10px 30px rgba(0,0,0,.25);
      color: #e5e7eb;
    }
    .slide-header{
      display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem;
    }
    .slide-title{ font-weight:800; letter-spacing:.4px; }
    .slide-clock{ font-variant-numeric: tabular-nums; opacity:.8; }
    .slide-grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(2,minmax(0,1fr));
    }
    @media (min-width: 900px){ .slide-grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
    @media (min-width: 1280px){ .slide-grid{ grid-template-columns: repeat(4,minmax(0,1fr)); } }

    .tile{
      background: var(--tile);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 18px;
      padding: 18px;
      color:#0b1020;
      display:flex; gap:12px; align-items:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.2); }
    .num{
      font-size: clamp(2.2rem, 6.8vw, 5rem);
      font-weight: 900; line-height: .9;
      color:#0b1020;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      min-width: 2.6ch; text-align:right;
    }
    .info{ flex:1; min-width: 0; }
    .name{
      font-size: clamp(1rem,2.4vw,1.25rem);
      font-weight: 700; white-space:nowrap; overflow:hidden; text-overflow: ellipsis;
      color:#111827;
    }
    .badges{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px }
    .badge{
      padding:.18rem .55rem; font-size:.75rem; border:1px solid rgba(0,0,0,.08); border-radius:.5rem;
      background: #fff; color:#374151;
    }
    .badge.pre{ border-color: rgba(16,185,129,.35); color:#065f46; background: rgba(16,185,129,.1); }
    .badge.walk{ border-color: rgba(99,102,241,.35); color:#3730a3; background: rgba(99,102,241,.1); }

    .flash { animation: flash 900ms ease-out; }
    @keyframes flash { 0%{ box-shadow:0 0 0 0 rgba(16,185,129,.9)} 60%{ box-shadow:0 0 0 22px rgba(16,185,129,0)} 100%{ box-shadow:none } }

    /* Fullscreen button subtle */
    .fs-btn{ background:rgba(255,255,255,.1); color:#e5e7eb; border:1px solid rgba(255,255,255,.15) }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center gap-3 mb-4" aria-label="Header">
      <h1 class="text-2xl font-bold">BloodDrive ‚Äî Control Panel</h1>
      <span id="conn" class="text-xs text-gray-500">connecting‚Ä¶</span>
      <span id="mode" class="text-xs text-gray-400">(socket)</span>
      <div class="ml-auto flex items-center gap-2">
        <a href="/api/export.csv" class="btn" aria-label="Export CSV">Export CSV</a>
        <button id="resetBtn" type="button" class="btn btn-warn" aria-label="Reset All Data">Reset</button>
      </div>
    </header>

    <!-- Desktop nav -->
    <nav class="hidden sm:flex flex-wrap gap-2 mb-4" aria-label="Primary">
      <button class="tab btn btn-primary" type="button" data-tab="register">Register</button>
      <button class="tab btn" type="button" data-tab="waiting">Waiting</button>
      <button class="tab btn" type="button" data-tab="screening">Screening</button>
      <button class="tab btn" type="button" data-tab="donation">Donation</button>
      <button class="tab btn" type="button" data-tab="recovery">Recovery</button>
      <button class="tab btn" type="button" data-tab="completed">Completed</button>
      <button class="tab btn" type="button" data-tab="rejected">Rejected</button>
      <button class="tab btn" type="button" data-tab="dashboard">Dashboard</button>
      <button class="tab btn" type="button" data-tab="slide">Waiting Slide</button>
    </nav>

    <!-- Mobile nav -->
    <nav class="mobile-bottom-nav sm:hidden fixed bottom-0 left-0 right-0 p-2 bg-white/95 border-t border-gray-200 z-50" aria-label="Mobile">
      <div class="grid grid-cols-7 gap-2">
        <button class="tab btn btn-primary" type="button" data-tab="register">üìù</button>
        <button class="tab btn" type="button" data-tab="waiting">‚è±Ô∏è</button>
        <button class="tab btn" type="button" data-tab="screening">ü©∫</button>
        <button class="tab btn" type="button" data-tab="donation">üíâ</button>
        <button class="tab btn" type="button" data-tab="recovery">ü•§</button>
        <button class="tab btn" type="button" data-tab="dashboard">üì∫</button>
        <button class="tab btn" type="button" data-tab="slide">üßæ</button>
      </div>
    </nav>

    <!-- REGISTER -->
    <section id="register" class="tabpane" aria-labelledby="Register">
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card">
          <h2 class="font-semibold mb-3">Manual Registration</h2>
          <div class="grid gap-2">
            <input id="fullName" class="border rounded px-3 py-3" placeholder="Full Name" autocomplete="off"/>
            <input id="phone" class="border rounded px-3 py-3" placeholder="Phone (optional)" autocomplete="off"/>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="preReg"/> Pre-Registered</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="consent" checked/> Photo Consent</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" id="hasPhoto"/> Has Photo (Booth)</label>
            <button id="addBtn" type="button" class="btn btn-primary">Add Donor</button>
          </div>
        </div>
        <div class="card">
          <h2 class="font-semibold mb-3">Live Stats</h2>
          <div id="stats" class="text-sm text-gray-600"></div>
        </div>
      </div>
    </section>

    <!-- WAITING -->
    <section id="waiting" class="tabpane hidden" aria-labelledby="Waiting">
      <div class="text-sm text-gray-600 mb-2">Send donors to Screening from here.</div>
      <div id="listWaiting" class="grid gap-2"></div>
    </section>

    <!-- SCREENING -->
    <section id="screening" class="tabpane hidden" aria-labelledby="Screening">
      <div class="flex items-center gap-2 mb-2">
        <input id="rejectReason" class="border rounded px-3 py-2 w-full sm:w-auto" placeholder="Rejection reason (optional)"/>
      </div>
      <div id="listScreening" class="grid gap-2"></div>
    </section>

    <!-- DONATION -->
    <section id="donation" class="tabpane hidden" aria-labelledby="Donation">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Beds (max 6)</h3>
          </div>
          <div id="listBeds" class="grid gap-2"></div>
        </div>
        <div class="card">
          <div class="flex items-center gap-2 justify-between mb-2">
            <h3 class="font-semibold">Chairs / Queue (max 6)</h3>
            <div class="flex gap-2">
              <button id="fillBedsStrict" type="button" class="btn btn-emerald"
                title="Requires 4 Pre-Registered + 2 Walk-In currently in chairs">Fill Beds 4+2 (strict)</button>
              <button id="fillBedsFifo" type="button" class="btn btn-sky"
                title="Fill any open beds in FIFO order">Fill Beds (FIFO)</button>
            </div>
          </div>
          <div id="listQueue" class="grid gap-2"></div>
        </div>
      </div>
    </section>

    <!-- RECOVERY -->
    <section id="recovery" class="tabpane hidden" aria-labelledby="Recovery">
      <div id="listRecovery" class="grid gap-2"></div>
    </section>

    <!-- COMPLETED -->
    <section id="completed" class="tabpane hidden" aria-labelledby="Completed">
      <div id="listCompleted" class="grid gap-2"></div>
    </section>

    <!-- REJECTED -->
    <section id="rejected" class="tabpane hidden" aria-labelledby="Rejected">
      <div id="listRejected" class="grid gap-2"></div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpane hidden" aria-labelledby="Dashboard">
      <div class="card grid sm:grid-cols-3 gap-4 text-center">
        <div class="p-4 rounded-lg bg-blue-50"><div class="text-4xl font-bold" id="kWaiting">0</div><div class="text-sm text-gray-600">Waiting</div></div>
        <div class="p-4 rounded-lg bg-amber-50"><div class="text-4xl font-bold" id="kQueue">0</div><div class="text-sm text-gray-600">In Chairs</div></div>
        <div class="p-4 rounded-lg bg-emerald-50"><div class="text-4xl font-bold" id="kBeds">0</div><div class="text-sm text-gray-600">In Beds</div></div>
      </div>
    </section>

    <!-- üî• WAITING SLIDE (Beautiful Fullscreen) -->
    <section id="slide" class="tabpane hidden" aria-labelledby="Waiting Slide">
      <div class="slide-wrap">
        <div class="slide-header">
          <h2 class="slide-title text-xl sm:text-2xl">Waiting Room ‚Äî Get Ready</h2>
          <span id="slideClock" class="slide-clock text-sm ml-2"></span>
          <div class="ml-auto flex items-center gap-2">
            <button id="slideFs" type="button" class="btn fs-btn">‚õ∂ Fullscreen</button>
          </div>
        </div>
        <div id="slideGrid" class="slide-grid"></div>
      </div>
    </section>
  </div>

<script>
(function(){
  const $ = (id)=> document.getElementById(id);
  const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const pill = (t)=> '<span class="pill">'+esc(t)+'</span>';
  const btn  = (label, action, id, cls='btn') => '<button type="button" class="'+cls+'" data-action="'+action+'" data-id="'+id+'">'+esc(label)+'</button>';

  // Tabs
  function showTab(name){
    document.querySelectorAll('.tab').forEach(x=> x.classList.toggle('btn-primary', x.dataset.tab===name));
    document.querySelectorAll('.tabpane').forEach(p=> p.classList.add('hidden'));
    (document.getElementById(name) || document.getElementById('register')).classList.remove('hidden');
    if (location.hash !== '#'+name) history.replaceState(null,'','#'+name);
  }
  document.querySelectorAll('.tab').forEach(b => b.addEventListener('click', ()=> showTab(b.dataset.tab)));
  window.addEventListener('hashchange', ()=> showTab((location.hash||'#register').slice(1)));
  showTab((location.hash||'#register').slice(1));

  // Live state: socket + polling fallback
  let state = { donors: [], meta: { nextDonorNo: 1 } };
  let pollTimer = null;

  function setConn(mode, text){
    const m = $('mode'); const c = $('conn');
    if (m) m.textContent = mode;
    if (c) c.textContent = text;
  }

  function renderFromServer(s){ state = s; scheduleRender(); }

  async function startPolling(){
    clearInterval(pollTimer);
    setConn('(polling)', 'polling');
    const poll = async () => {
      try{
        const r = await fetch('/api/state?v='+Date.now(), { cache:'no-store' });
        if (r.ok) renderFromServer(await r.json());
      }catch{}
    };
    await poll();
    pollTimer = setInterval(poll, 4000);
  }

  try{
    const socket = io();
    setConn('(socket)', 'connected');
    socket.on('connect', ()=> { setConn('(socket)', 'connected'); clearInterval(pollTimer); });
    socket.on('disconnect', ()=> { setConn('(socket)', 'offline'); startPolling(); });
    socket.on('state', renderFromServer);
  }catch{ startPolling(); }

  // Actions
  $('resetBtn').addEventListener('click', async ()=>{
    if (!confirm('Reset ALL data?')) return;
    await fetch('/api/reset',{ method:'POST' });
  });
  $('addBtn').addEventListener('click', async ()=>{
    const body = {
      FullName: $('fullName').value.trim(),
      Phone: $('phone').value.trim(),
      PreRegistered: document.getElementById('preReg').checked,
      PhotoConsent: document.getElementById('consent').checked,
      HasPhoto: document.getElementById('hasPhoto').checked,
    };
    if (!body.FullName) { alert('Full Name required'); $('fullName').focus(); return; }
    try{
      const r = await fetch('/api/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if (!r.ok) { const j = await r.json().catch(()=>({})); alert(j.error || 'Register failed'); return; }
      $('fullName').value=''; $('phone').value=''; document.getElementById('preReg').checked=false; document.getElementById('hasPhoto').checked=false; document.getElementById('consent').checked=true;
    }catch{ alert('Cannot reach server.'); }
  });

  function delegate(containerId, map){
    const el = $(containerId);
    el.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-action]');
      if (!b) return;
      const id = b.dataset.id;
      const fn = map[b.dataset.action];
      if (!fn) return;
      try{
        const res = await fn(id);
        if (res && !res.ok) {
          const j = await res.json().catch(()=>({}));
          alert(j.error || 'Action failed');
        }
      }catch{ alert('Action failed'); }
    });
  }

  const api = {
    toScreening: (id)=> fetch('/api/action/send-to-screening',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }),
    approve: async (id)=> {
      const r = await fetch('/api/action/approve',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
      if (!r.ok) { const j = await r.json().catch(()=>({})); alert(j.error || 'Unable to approve'); }
    },
    reject:  (id)=> {
      const reason = $('rejectReason').value.trim();
      return fetch('/api/action/reject',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, reason }) });
    },
    moveToBed: (id)=> fetch('/api/action/move-to-bed',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }),
    fillStrict: ()=> fetch('/api/action/fill-beds-4p2',{ method:'POST' }),
    fillFifo:   ()=> fetch('/api/action/fill-beds-fifo',{ method:'POST' }),
    toRecovery: (id)=> fetch('/api/action/to-recovery',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }),
    recovered:  (id)=> fetch('/api/action/recovered',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }),
    complete:   (id)=> fetch('/api/action/complete',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }),
  };

  $('fillBedsStrict')?.addEventListener('click', async ()=>{
    const r = await api.fillStrict();
    if (!r.ok) { const j = await r.json().catch(()=>({})); alert(j.error || '4+2 not available'); }
  });
  $('fillBedsFifo')?.addEventListener('click', ()=> api.fillFifo());

  delegate('listWaiting',   { 'toScreening': api.toScreening });
  delegate('listScreening', { 'approve': api.approve, 'reject': api.reject });
  delegate('listBeds',      { 'toRecovery': api.toRecovery });
  delegate('listRecovery',  { 'recovered': api.recovered, 'complete': api.complete });
  delegate('listQueue',     { 'moveToBed': api.moveToBed });

  // UI builders
  const card = (d, buttons='') =>
    '<div class="card">'
    + '<div class="flex items-center justify-between">'
    +   '<div class="font-semibold">#'+esc(d.DonorID)+' ‚Äî '+esc(d.FullName)+'</div>'
    +   '<div class="text-xs '+(d.PreRegistered?'text-emerald-700':'text-indigo-700')+'">'+(d.PreRegistered ? 'Pre-Registered' : 'Walk-In')+'</div>'
    + '</div>'
    + '<div class="text-xs text-gray-600 flex gap-2 items-center flex-wrap">'
    +   pill(d.Status)+' <span>Screening: <b>'+esc(d.ScreeningStatus||'')+'</b></span>'
    + '</div>'
    + '<div class="pt-2 flex flex-wrap gap-2">'+buttons+'</div>'
    + '</div>';

  // ---------- Beautiful Waiting Slide ----------
  function tileHTML(d){
    return `
      <div class="tile" data-id="${d.id}">
        <div class="num">#${esc(d.DonorID)}</div>
        <div class="info">
          <div class="name">${esc(d.FullName)}</div>
          <div class="badges">
            <span class="badge ${d.PreRegistered ? 'pre' : 'walk'}">${d.PreRegistered ? 'Pre-Registered' : 'Walk-In'}</span>
            <span class="badge">Waiting</span>
          </div>
        </div>
      </div>
    `;
  }

  // diff render for slide (only updates what changed)
  function diffRender(containerId, items, renderItem){
    const el = $(containerId);
    const existing = new Map([...el.children].map(ch => [ch.getAttribute('data-id'), ch]));
    const nextIds = new Set(items.map(x => x.id));

    // remove stale
    existing.forEach((node, id) => { if (!nextIds.has(id)) node.remove(); });

    // build in order
    const frag = document.createDocumentFragment();
    items.forEach(item => {
      let node = existing.get(item.id);
      if (!node) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = renderItem(item).trim();
        node = wrapper.firstElementChild;
        node.classList.add('flash');
        setTimeout(()=> node.classList.remove('flash'), 900);
      } else {
        // minimal patch: replace inner content except container attrs
        node.outerHTML = renderItem(item).trim();
        node = el.querySelector(`[data-id="${item.id}"]`);
      }
      frag.appendChild(node);
    });

    // replace content fast
    el.innerHTML = '';
    el.appendChild(frag);
  }

  // fullscreen control
  $('slideFs')?.addEventListener('click', ()=>{
    const pane = $('slide');
    if (!document.fullscreenElement) (pane || document.documentElement).requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  });

  // clock in slide
  function tickClock(){
    const c = $('slideClock'); if (!c) return;
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    c.textContent = `${hh}:${mm}`;
  }
  setInterval(tickClock, 1000); tickClock();

  // ---------- Throttled render ----------
  let renderTimer = null;
  function scheduleRender(){
    if (renderTimer) return;
    renderTimer = setTimeout(()=>{ renderTimer = null; render(); }, 100);
  }

  function render(){
    const donors = state.donors || [];
    const waitingN  = donors.filter(d=>d.Status==='Waiting').length;
    const screenN   = donors.filter(d=>d.Status==='Screening').length;
    const queueN    = donors.filter(d=>d.Status==='Donation-Queue').length;
    const bedsN     = donors.filter(d=>d.Status==='Donation-In-Progress').length;

    $('stats').textContent = `Waiting: ${waitingN} ‚Ä¢ Screening: ${screenN} ‚Ä¢ Chairs: ${queueN}/6 ‚Ä¢ Beds: ${bedsN}/6`;

    $('listWaiting').innerHTML = donors
      .filter(d=>d.Status==='Waiting')
      .sort((a,b)=> new Date(a.RegisteredAt)-new Date(b.RegisteredAt))
      .map(d => card(d, btn('Send to Screening', 'toScreening', d.id, 'btn btn-purple')))
      .join('') || '<div class="text-sm muted">No donors in waiting.</div>';

    $('listScreening').innerHTML = donors
      .filter(d=>d.Status==='Screening')
      .sort((a,b)=> new Date(a.ScreeningStartAt||a.RegisteredAt) - new Date(b.ScreeningStartAt||b.RegisteredAt))
      .map(d => card(d, btn('Approve (to Chairs)', 'approve', d.id, 'btn btn-ok') + ' ' + btn('Reject', 'reject', d.id, 'btn btn-warn')))
      .join('') || '<div class="text-sm muted">No donors in screening.</div>';

    $('listBeds').innerHTML = donors
      .filter(d=>d.Status==='Donation-In-Progress')
      .sort((a,b)=> new Date(a.DonationStartAt||0) - new Date(b.DonationStartAt||0))
      .map(d => card(d, btn('To Recovery', 'toRecovery', d.id, 'btn btn-sky')))
      .join('') || '<div class="text-sm muted">No one in beds.</div>';

    $('listQueue').innerHTML = donors
      .filter(d=>d.Status==='Donation-Queue')
      .sort((a,b)=> new Date(a.ApprovedAt||0) - new Date(b.ApprovedAt||0))
      .map(d => card(d, btn('Move to Bed', 'moveToBed', d.id, 'btn btn-primary')))
      .join('') || '<div class="text-sm muted">No one in chairs.</div>';

    $('listRecovery').innerHTML = donors
      .filter(d=>d.Status==='Recovery')
      .map(d => card(d, btn('Recovered', 'recovered', d.id, 'btn') + ' ' + btn('Complete & Give Pack', 'complete', d.id, 'btn btn-emerald')))
      .join('') || '<div class="text-sm muted">No one in recovery.</div>';

    $('listCompleted').innerHTML = donors
      .filter(d=>d.Status==='Completed & Left')
      .map(d=> card(d, ''))
      .join('') || '<div class="text-sm muted">No completed donors yet.</div>';

    $('listRejected').innerHTML = donors
      .filter(d=>d.Status==='Rejected')
      .map(d=> card(d, ''))
      .join('') || '<div class="text-sm muted">No rejected donors.</div>';

    $('kWaiting').textContent = waitingN;
    $('kQueue').textContent   = `${queueN}/6`;
    $('kBeds').textContent    = `${bedsN}/6`;

    // Beautiful Waiting Slide: show top 12 "Waiting"
    const w = donors
      .filter(d => d.Status === 'Waiting')
      .sort((a,b)=> new Date(a.RegisteredAt||0) - new Date(b.RegisteredAt||0))
      .slice(0, 12);
    diffRender('slideGrid', w, tileHTML);
  }

  // initial render
  scheduleRender();
})();
</script>
</body>
</html>
